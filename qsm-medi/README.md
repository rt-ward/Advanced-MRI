# QSM-MEDI Pipeline

## Introduction
Developed for use in the CLARiTI consortium by Dr. Arnold Evia from the Rush Alzheimer's Disease 
Center. For any questions, please email Dr. Evia (Arnold_Evia@rush.edu).

*** IMPORTANT: PLEASE CITE WORKS BELOW WHEN USING THIS CONTAINER ***
- hd-bet, doi: 10.1002/hbm.24750
- mSMV, doi: 10.1002/mrm.29963
- Nonlinear fitting, doi: 10.1002/mrm.24272
- ROMEO phase unwrapping, doi: 10.1002/mrm.28563
- PDF background field removal, doi: 10.1002/nbm.1670
- ARLO R2s fitting, doi: 10.1002/mrm.25137
- Homogeneity mask (CSF mask), doi: 10.1111/jon.12923
- MEDI reconstruction, doi: 10.1016/j.neuroimage.2011.08.082


## Release Notes
- 2.2.0 (01/21/26)

        - Initial version


## Pipeline Description
The default pipeline is the following: 
1. Combine real and imaginary data, if needed
2. Frequency maps are generated by non-linearly fitting all the echoes from the gradient-echo sequence in the complex 
plane. 
3. Unwrap phase wraps using ROMEO
4. Background field removal using Projection onto Dipole Fields (PDF)
5. Additional background field removal while maintaining signal at the edges of the mask using mSMV
6. Dipole inversion with reference value is performed with MEDI+0. QSM maps have a reference value set to the QSM value 
of the CSF. Note that the background voxels have a value of the reference value. 

Various components of the pipeline can be modified with a config file, including unwrap method, background field 
removal method, application of mSMV method, and convergence parameters.

## Config variables

- "load_negate_every_other_axis"
  - "description": "Axis to apply preprocessing fix on real and imaginary data by negating every other slice along an axis. can only have values of 'row', 'col', or 'slice'",
  - "type": "string",
  - "enum": [
    "row",
    "col",
    "slice"
  ],
  - "optional": true

- "method_phase_unwrap"
  - "description": " Choice of phase unwrap method. Can only have values of 'romeo' or 'laplacian'. laplacian works better on data containing open ended fringe lines",
  - "type": "string",
  - "default": "romeo",
  - "enum": [
    "romeo",
    "laplacian"
  ]

- "invert_phase"
  - "description": " Use the complex conjugate of the original data. Setting this to 1 results in the original QSM map with negated values.",
  - "type": "integer",
  - "default": 0

- "csf_thresh_R2s"
  - "description": " R2 star threshold for extract_all_CSF()",
  - "type": "integer",
  - "default": 5

- "pdf_tol"
  - "description": "Tolerance level for PDF",
  - "type": "number",
  - "default": 0.1

- "pdf_n_cg"
  - "description": "Max number of iterations for PDF",
  - "type": "integer",
  - "default": 30

- "pdf_space"
  - "description": "Domain for PDF dipole kernel (option only used for oblique B0 directions). can only have values of 'imagespace' or 'kspace'",
  - "type": "string",
  - "default": "imagespace",
  - "enum": [
    "imagespace",
    "kspace"
  ]

- "pdf_n_pad"
  - "description": "Zero-padding that is added and removed for PDF processing",
  - "type": "integer",
  - "default": 40

- "medi_max_iter"
  - "description": "Max number of iterations for MEDI_L1",
  - "type": "integer",
  - "default": 10

- "csf_flag_erode"
  - "description": "Erosion flag for extract_all_CSF(). can only have values of 0 and 1",
  - "type": "integer",
  - "default": 1

- "medi_tol_norm_ratio"
  - "description": "Tolerance level for MEDI_L1",
  - "type": "number",
  - "default": 0.1

- "medi_cg_verbose"
  - "description": "Verbose flag for cg method in MEDI_L1",
  - "type": "integer",
  - "default": 0

- "medi_cg_max_iter"
  - "description": "Max number of iterations for cg method in MEDI_L1",
  - "type": "integer",
  - "default": 100

- "medi_cg_tol"
  - "description": "Tolerance level for cg method in MEDI_L1",
  - "type": "number",
  - "default": 0.1

- "medi_lambda"
  - "description": "L1 regularization parameter for MEDI_L1",
  - "type": "integer",
  - "default": 1000

- "medi_msmv"
  - "description": "Radius for msmv",
  - "type": "integer",
  - "default": 5

- "load_nifti_common_prefix"
  - "description": "common prefix for nifti files in temp_dcm2niix (should be empty string for dicom inputs)",
  - "type": "string",
  - "optional": true

- "phase_corr"
  - "description": "flag to apply removal of echo-dependent linear phase gradient to avoid non-2pi wrap-like artifacts (iField_correction.m). can only have values of 0 and 1",
  - "type": "integer",
  - "default": 1

- "prefilter"
  - "description": "Prefilter option for MEDI and msmv. possible values are: -1 for variable radius smv, 1 for fixed radius smv",
  - "type": "integer",
  - "default": -1